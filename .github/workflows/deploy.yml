name: Deploy to Hetzner on push to main

on:
  push:
    branches:
      - main

jobs:
  tests:
    runs-on: ubuntu-latest
    env:
      APP_ENV: dev
      DEBUG: "False"
      DB_HOST: localhost
      DB_PORT: "5432"
      DB_USER: postgres
      DB_PASSWORD: postgres
      DB_NAME: test_db
      DB_SSLMODE: disable
      DB_BOOTSTRAP_SCHEMA: "false"
      DB_POOL_PRE_PING: "true"
      DB_POOL_RECYCLE: "0"
      RUN_MIGRATIONS_ON_STARTUP: "false"
      TELEGRAM_CHAT_ID: "123456789"
      TELEGRAM_BOT_TOKEN: dummy_test_token
      TELEGRAM_ADMIN_ID: "987654321"
      TELEGRAM_USE_WEBHOOK: "false"
      WEBHOOK_PREFIX: https://example.com
      WEBHOOK_SLUG: ci_slug
      WEBHOOK_SECRET_TOKEN: ci_secret
      WEBHOOK_PORT: "443"
      DEEPSEEK_API_KEY: test
      DEEPSEEK_BASE_URL: https://api.example.com
      DEEPSEEK_MODEL: deepseek-test-model
      SENTRY_DSN: https://example.com/ci
      ALLOWED_HOSTS: localhost,127.0.0.1
      SERVE_STATIC_FROM_APP: "false"
      UVICORN_WORKERS: "1"
      CORS_ORIGINS: http://localhost:5173
      ADMIN_LOGIN: admin
      ADMIN_PASSWORD: admin
      ADMIN_CREATE_ON_STARTUP: "true"
      PASSWORD_PEPPER: test_pepper_string
      REDIS_HOST: localhost
      REDIS_PORT: "6379"
      REDIS_DB: "0"
      REDIS_PASSWORD: testpassword

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install uv
        uv pip install --system -r backend/requirements.txt
        uv pip install --system -r requirements-dev.txt

    - name: Run linters (black, isort, ruff, mypy)
      run: |
        pre-commit run --all-files

    - name: Run tests
      run: |
        pytest

  deploy:
    needs: tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Add SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H 91.99.6.156 >> ~/.ssh/known_hosts
    
    - name: Sync files to server
      run: |
        rsync -az --delete \
          --exclude '.git' \
          --exclude '.github' \
          --exclude '.env' \
          ./ root@91.99.6.156:/root/smart_menu_bot_prod/

    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=yes -T root@91.99.6.156 <<'EOF'
          set -e
          cd /root/smart_menu_bot_prod
          ./refresh.sh
        EOF
