{% extends "sqladmin/layout.html" %}

{% block content %}
<div class="col-12">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Redis ключи</h3>
    </div>
    <div class="card-body border-bottom py-3">
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div class="text-muted">
          Всего ключей: {{ total_keys }}. Страница {{ page }}. Показано до {{ per_page }} ключей.
        </div>
        <div class="btn-list">
          {% if prev_page %}
          <a class="btn btn-outline-secondary btn-sm" href="{{ request.url.include_query_params(page=prev_page) }}">
            Назад
          </a>
          {% endif %}
          {% if has_more %}
          <a class="btn btn-outline-secondary btn-sm" href="{{ request.url.include_query_params(page=next_page) }}">
            Вперед
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table card-table table-vcenter text-nowrap">
        <thead>
          <tr>
            <th>Ключ</th>
            <th>TTL</th>
            <th class="w-1">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
          {% for row in rows %}
          <tr>
            <td style="word-break: break-all;">
              <button class="btn btn-link p-0 text-start redis-toggle" type="button"
                data-key="{{ row.key }}" data-target="redis-value-{{ loop.index }}">
                {{ row.key }}
              </button>
            </td>
            <td>{{ row.ttl }}</td>
            <td>
              <form method="post" action="{{ base_path }}/delete" style="margin:0;">
                <input type="hidden" name="key" value="{{ row.key }}">
                <input type="hidden" name="page" value="{{ page }}">
                <button class="btn btn-danger btn-sm" type="submit">Удалить</button>
              </form>
            </td>
          </tr>
          <tr id="redis-value-{{ loop.index }}" class="d-none">
            <td colspan="3">
              <div class="text-muted small redis-value" style="white-space: pre-wrap; word-break: break-word;">
                Загрузка...
              </div>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="3" class="text-muted">Нет ключей</td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block tail %}
<script>
  document.addEventListener("click", function (event) {
    var btn = event.target.closest(".redis-toggle");
    if (!btn) {
      return;
    }
    var targetId = btn.getAttribute("data-target");
    var key = btn.getAttribute("data-key") || "";
    var row = document.getElementById(targetId);
    if (!row) {
      return;
    }
    row.classList.toggle("d-none");
    if (row.classList.contains("d-none")) {
      return;
    }
    if (row.getAttribute("data-loaded") === "1") {
      return;
    }
    var valueEl = row.querySelector(".redis-value");
    if (valueEl) {
      valueEl.textContent = "Загрузка...";
    }
    fetch("{{ base_path }}/value?key=" + encodeURIComponent(key))
      .then(function (response) { return response.json(); })
      .then(function (data) {
        if (!valueEl) {
          return;
        }
        if (data.error) {
          valueEl.textContent = "Ошибка: " + data.error;
        } else if (data.missing) {
          valueEl.textContent = "Ключ не найден";
        } else {
          valueEl.textContent = data.value || "";
        }
        row.setAttribute("data-loaded", "1");
      })
      .catch(function () {
        if (valueEl) {
          valueEl.textContent = "Ошибка загрузки";
        }
      });
  });
</script>
{% endblock %}
