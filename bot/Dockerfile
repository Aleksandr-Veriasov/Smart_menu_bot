# –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑
FROM python:3.10-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONPATH=/app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && apt-get install -y --no-install-recommends tini \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY bot/requirements.txt /tmp/requirements.txt
RUN pip install uv && uv pip install --system -r /tmp/requirements.txt

# non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –ø—Ä–∞–≤–∞
RUN groupadd -g 100 users || true \
    && useradd -r -u 10002 -g users appuser \
    && mkdir -p /app/.cache \
    && chown -R appuser:users /app
USER appuser

# –ö—É–¥–∞ –∫–ª–∞—Å—Ç—å –∫—ç—à –º–æ–¥–µ–ª–µ–π
ENV XDG_CACHE_HOME=/app/.cache

# üîΩ –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å whisper 'base'
RUN python3 -c "import whisper; whisper.load_model('base')"

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç
COPY packages /app/packages
COPY bot  /app/bot
COPY ./alembic.ini /app/alembic.ini

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
ENTRYPOINT ["/usr/bin/tini","--"]
CMD ["python", "-m", "bot.app.start_bot"]
